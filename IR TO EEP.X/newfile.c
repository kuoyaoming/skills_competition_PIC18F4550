#include <p18cxxx.h>

#pragma config FOSC=HS, WDT=OFF, BOR = ON_ACTIVE, BORV = 1, LVP=OFF, PBADEN=OFF, XINST = OFF, MCLRE = ON

#define beep   RD2 //???????

unsigned char tmr_times;
unsigned char code_data;
unsigned char code;
unsigned char int_times;
unsigned char buf1;
unsigned int  fengcon;
bit head_ok;  	
bit beepbit;

//---------------------------------------
//??: T0?????		 
//???cby
//?????????????
//???www.MovingChip.com
//???20110601
//-----------------------------------------
void init_timer0(void)
{
	TMR0IF=0;    //T0???????
    TMR0IE=1;    //T0????
    T0CON=0xC8;  //8bit???????????	
	TMR0L=0x13;  //??4.0M,??250us
    GIE=1;   	 //????
}
//---------------------------------------
//??: ????????		 
//???cby
//?????????????
//???www.MovingChip.com
//???20110601 
//-----------------------------------------
void wrong(void)  //??????????????????????
{
  	int_times=0;
  	tmr_times=0;
  	head_ok=0;
  	code_data=0;  	
}
//---------------------------------------
//??: 0?1????		 
//???cby
//?????????????
//???www.MovingChip.com
//???20110601
//-----------------------------------------
unsigned char one_zero(void)
{  	
	//???????HT6221?????0????????1.12ms
	//?????????0.25ms,?????????0.75ms??1.5ms?????0??
  	if((tmr_times>3)&(tmr_times<6))
  	{
    	return 0;
  	}
	//???????HT6221?????1????????2.24ms
	//?????????0.25ms,?????????1.75ms??2.75ms?????0??
  	else if((tmr_times>7)&(tmr_times<11))
  	{
    	return 1;
  	}
	//????????0.75-1.5ms??1.75-2.75ms??????????????2
  	return 2;
}
//---------------------------------------
//??: CCP2?????		 
//???cby
//?????????????
//???www.MovingChip.com
//???20110601
//-----------------------------------------
void ccp2_int(void)
{
	CCP2CON=0x04;			//????????????
	T1CON=0x00;				//CCP????????T1???????????????????
	TRISC1=1;               //RC1?????????????????????????
	CCP2IF=0;               //?????????
	CCP2IE=1;				//???????
	TMR1ON=1;	            //T1??
}
//---------------------------------------
//??: ??????		 
//???cby
//?????????????
//???www.MovingChip.com
//???20110601
//-----------------------------------------
void interrupt ISR(void)    //??????
{	
		
  	if(TMR0IF==1)           //???T0??????1??250US????????
  	{
		TMR0L=0x13;  //??4.0M,??250us
  		TMR0IF=0;           //??TO?????  		
  		tmr_times++;	    //?????????????????????
  	}
	 if(CCP2IF==1)          //??????????1???CCP2???????????
	 {
		CCP2IF=0;            //??CCP2???????      
		GIE=0; 				 //????????????????????	 
  		int_times++;  		 //??????	
  		if(head_ok==0)      	//????????????????????????
  		{
			//???????HT6221???????????????9ms???????4.5ms??????
			//?????????0.25ms,????????12.5ms??14.5ms?????13.5ms?????
    		if(tmr_times>45&tmr_times<58)		
    		{
      			head_ok=1;  	//??????????????????
      			int_times=0;    //????????????????????4??32???
      			tmr_times=0;    //?????????????????????????	       
    		}
    		else
    		{
      			wrong();        //??????????????????
    		}
  		}
  		else                	//??????????????????32???????                    
  		{    
    		code_data=code_data>>1; //???????????????????
			buf1=one_zero();    		//?????0?1??????
			tmr_times=0;  		    //???????????			
    		if(buf1==1)			//?????1
    		{
      			code_data|=0x80;  	//?1??code_data????
    		}    	
			else if(buf1==0)			//?????0
	        {
      			code_data&=0x7f;  	//?0??code_data????
    		}    
			else            		//???0?1??????
            {
				wrong();       		//????????
				return;
			}    						
    		if(int_times==8)        //?????8??????????8?????????
    		{
				//??????8?????0X00????????????????????????
        		if(code_data!=0x00)  //????0x00 ????????????????????
        		{
        			wrong();         //????????      
					return;  
        		}    		
    		}
    		else if(int_times==16)        //?????16??????????8?????????
    		{
				//???????8?????0XFF
        		if(code_data!=0xFF)  //????0xff ????????????????????
        		{
            		wrong();         //????????      
					return;
        		}	        			
    		}
    		else if(int_times==24)    //??????8?????8????
    		{
      			code=code_data;    //???8???????code_data1  			
    		}
    		else if(int_times==32)    //??????8?????8???????
    		{
      			int_times=0;      	  //??????????????????		
      			head_ok=0;            //???????????????????????			 			  
      			if((code+code_data)==0xff)    //???????????????????  			
      			{          			
            		beepbit=1;            	  //????????????????????????	
            	}      			
    		}
  		}   		
  		  		
  	} 
  	GIE=1;   	//??????
}
//---------------------------------------
//??: ?????
//???cby
//?????????????
//???www.MovingChip.com
//???20110601
//----------------------------------------- 
void fengpro(void)
{
	if(beepbit==1)
	{		
		beep=1;
		if(++fengcon>1000)
		{
			fengcon=0;
			beepbit=0;			
		}		 	
	}	
	else
	{
		beep=0;
	}
}
//---------------------------------------
//??: ???
//???cby
//?????????????
//???www.MovingChip.com
//???20110601
//----------------------------------------- 
main(void)
{
  	unsigned char buf;
	OSCCON=0X00;    		//??????
	ADCON1=0X0f;            //??IO?????????????
	TRISC=0B11111111;   	//Rc??????
    TRISD=0B11111011;   	//RD2?????
  	init_timer0();          //TO?????
  	ccp2_int();	            //CCP2?????  
	beepbit=1;	
  	while(1)
  	{ 
    	fengpro();	
  	}
}

